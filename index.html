<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Cleanliness Dashboard</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --accent-color: #fbbc04;
            --warning-color: #ea4335;
            --light-bg: #f8f9fa;
            --dark-bg: #202124;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            color: #333;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .airport-header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .airport-header h1 {
            margin: 0;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .airport-header h1 i {
            font-size: 2.2rem;
        }
        
        .airport-header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .date-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
        }
        
        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .section-title {
            color: #1a73e8;
            border-bottom: 2px solid #e8f0fe;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #1a73e8;
        }
        
        .file-upload-area {
            border: 3px dashed #dadce0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: #e8f0fe;
        }
        
        .file-upload-area.dragover {
            border-color: var(--secondary-color);
            background: #e6f4ea;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #1a73e8;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .stat-card.terminal {
            border-left-color: #1a73e8;
        }
        
        .stat-card.gates {
            border-left-color: #34a853;
        }
        
        .stat-card.score {
            border-left-color: #fbbc04;
        }
        
        .stat-card.issues {
            border-left-color: #ea4335;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stat-card.terminal .stat-icon {
            background: #1a73e8;
        }
        
        .stat-card.gates .stat-icon {
            background: #34a853;
        }
        
        .stat-card.score .stat-icon {
            background: #fbbc04;
        }
        
        .stat-card.issues .stat-icon {
            background: #ea4335;
        }
        
        .stat-content h3 {
            margin: 0;
            font-size: 2.2rem;
            color: #202124;
        }
        
        .stat-content p {
            margin: 5px 0 0;
            color: #5f6368;
            font-weight: 500;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }
        
        canvas {
            width: 100% !important;
            height: 320px !important;
        }
        
        .data-storage-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        #dataStorageInfo {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .data-table-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .table thead {
            position: sticky;
            top: 0;
            background: #1a73e8;
            color: white;
            z-index: 10;
        }
        
        .table th {
            padding: 15px;
            font-weight: 600;
            border: none;
        }
        
        .table td {
            padding: 12px 15px;
            vertical-align: middle;
            border-color: #e0e0e0;
        }
        
        .table tbody tr:hover {
            background-color: #f1f8ff;
        }
        
        .score-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .score-high {
            background-color: #e6f4ea;
            color: #137333;
        }
        
        .score-medium {
            background-color: #fef7e0;
            color: #b06000;
        }
        
        .score-low {
            background-color: #fce8e6;
            color: #c5221f;
        }
        
        .btn-airport {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-airport:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(26, 115, 232, 0.3);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ea4335 0%, #b31412 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 28px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #34a853 0%, #0d652d 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 28px;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fbbc04 0%, #b06000 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 28px;
        }
        
        .progress {
            height: 12px;
            margin-top: 15px;
            border-radius: 6px;
            background-color: #e8f0fe;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #1a73e8, #34a853);
            border-radius: 6px;
        }
        
        .upload-status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .status-success {
            background-color: #e6f4ea;
            color: #137333;
            border-left: 4px solid #34a853;
        }
        
        .status-error {
            background-color: #fce8e6;
            color: #c5221f;
            border-left: 4px solid #ea4335;
        }
        
        .status-warning {
            background-color: #fef7e0;
            color: #b06000;
            border-left: 4px solid #fbbc04;
        }
        
        .uploaded-files {
            margin-top: 25px;
        }
        
        .file-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #1a73e8;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-icon {
            color: #1a73e8;
            font-size: 1.5rem;
        }
        
        .file-details h5 {
            margin: 0;
            font-size: 1rem;
        }
        
        .file-details small {
            color: #5f6368;
        }
        
        .badge-uploaded {
            background: #34a853;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .data-summary-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .data-summary-item h5 {
            margin: 0 0 10px 0;
            color: #1a73e8;
            font-size: 1rem;
        }
        
        .data-summary-item p {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: #202124;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #5f6368;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
            margin-top: 30px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .airport-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .date-display {
                width: 100%;
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                flex-direction: column;
                text-align: center;
            }
        }
        
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .records-info {
            font-weight: 600;
            color: #1a73e8;
        }
        
        .pagination-buttons .btn {
            margin: 0 5px;
        }
        
        .storage-indicator {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: #e8f0fe;
            text-align: center;
            font-weight: 600;
            color: #1a73e8;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Airport Header -->
        <div class="airport-header">
            <div>
                <h1><i class="fas fa-plane-departure"></i> Airport Cleanliness Dashboard</h1>
                <p class="subtitle">Comprehensive monitoring and analysis of airport terminal cleanliness, maintenance, and compliance</p>
            </div>
            <div class="date-display">
                <i class="fas fa-calendar-alt"></i> 
                <span id="currentDate">Loading...</span>
            </div>
        </div>
        
        <!-- Upload Section -->
        <div class="upload-section">
            <h3 class="section-title"><i class="fas fa-file-upload"></i> Upload Airport Data Files</h3>
            <p>Upload CSV files containing terminal data, gate information, cleanliness inspections, maintenance logs, or staff schedules</p>
            
            <div class="file-upload-area" id="dropArea">
                <div>
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Drag & Drop Airport CSV Files Here</h4>
                    <p class="text-muted">or click the button below to browse files</p>
                    <input type="file" id="fileInput" accept=".csv" multiple style="display: none;">
                    <button class="btn btn-airport" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> Browse Airport Files
                    </button>
                    <p class="text-muted mt-3">Supported files: Terminal data, Gate inspections, Cleanliness scores, Maintenance logs, Staff schedules</p>
                </div>
            </div>
            
            <div class="uploaded-files" id="fileList">
                <!-- Uploaded files will appear here -->
            </div>
            
            <div id="uploadStatus" class="upload-status"></div>
            
            <div class="progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            
            <!-- Storage Status Indicator -->
            <div id="storageStatus" class="storage-indicator" style="display: none;">
                <i class="fas fa-database"></i> <span id="storagePercent">0%</span> of browser storage used
            </div>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="stats-grid">
            <div class="stat-card terminal">
                <div class="stat-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalTerminals">0</h3>
                    <p>Terminals</p>
                </div>
            </div>
            
            <div class="stat-card gates">
                <div class="stat-icon">
                    <i class="fas fa-door-open"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalGates">0</h3>
                    <p>Gates</p>
                </div>
            </div>
            
            <div class="stat-card score">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-content">
                    <h3 id="avgScore">0.0</h3>
                    <p>Average Cleanliness Score</p>
                </div>
            </div>
            
            <div class="stat-card issues">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalIssues">0</h3>
                    <p>Maintenance Issues</p>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3 class="section-title"><i class="fas fa-chart-line"></i> Monthly Cleanliness Trends</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="section-title"><i class="fas fa-chart-bar"></i> Weekly Performance</h3>
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>
        
        <!-- Data Storage Section -->
        <div class="data-storage-section">
            <h3 class="section-title"><i class="fas fa-database"></i> Airport Data Storage</h3>
            <div id="dataStorageInfo">
                <div class="data-summary">
                    <div class="data-summary-item">
                        <h5>Terminal Data</h5>
                        <p id="terminalCount">0</p>
                    </div>
                    <div class="data-summary-item">
                        <h5>Gate Data</h5>
                        <p id="gateCount">0</p>
                    </div>
                    <div class="data-summary-item">
                        <h5>Cleanliness Records</h5>
                        <p id="cleanlinessCount">0</p>
                    </div>
                    <div class="data-summary-item">
                        <h5>Maintenance Logs</h5>
                        <p id="maintenanceCount">0</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="exportAllDataCSV()" class="btn btn-success">
                    <i class="fas fa-file-export"></i> Export All Airport Data (CSV)
                </button>
                <button onclick="debugStorage()" class="btn btn-warning">
                    <i class="fas fa-bug"></i> Debug Storage
                </button>
                <button onclick="clearAllData()" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> Clear All Data
                </button>
            </div>
        </div>
        
        <!-- Complete Data Table Section -->
        <div class="data-table-section">
            <h3 class="section-title"><i class="fas fa-table"></i> Complete Airport Cleanliness Data</h3>
            <div id="dataTableContainer">
                <p class="text-muted">Upload airport cleanliness data to see the complete records here.</p>
            </div>
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <div class="records-info" id="recordsInfo">Showing 0 of 0 records</div>
                <div class="pagination-buttons">
                    <button class="btn btn-outline-primary" onclick="changePage(-1)" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-outline-primary" onclick="changePage(1)" id="nextBtn" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Airport Cleanliness Dashboard v2.0 | Data last updated: <span id="lastUpdated">Never</span></p>
            <p class="text-muted">All data is stored locally in your browser | For airport operations use only</p>
        </div>
    </div>

    <script>
        // Data storage object for airport data
        let airportData = {
            terminalData: [],
            gateData: [],
            cleanlinessData: [],
            maintenanceData: [],
            staffData: [],
            otherData: []
        };

        // Chart instances
        let monthlyChart = null;
        let weeklyChart = null;

        // Pagination variables
        let currentPage = 1;
        const recordsPerPage = 50;
        let totalRecords = 0;

        // DOM elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = uploadProgress.querySelector('.progress-bar');
        const storageStatus = document.getElementById('storageStatus');
        const storagePercent = document.getElementById('storagePercent');

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('lastUpdated').textContent = 'Never';

            // Check for saved airport data
            const savedData = localStorage.getItem('airportCleanlinessData');
            if (savedData) {
                try {
                    airportData = JSON.parse(savedData);
                    updateDataStorageDisplay();
                    updateDashboardStats();
                    updateCharts();
                    updateCompleteDataTable();
                    loadUploadedFilesList();
                    showStatus('Previous airport data loaded successfully!', 'success');
                    
                    // Update last updated time
                    const lastSave = localStorage.getItem('airportDataLastUpdated');
                    if (lastSave) {
                        document.getElementById('lastUpdated').textContent = new Date(lastSave).toLocaleString();
                    }
                    
                    // Update storage status
                    updateStorageStatus();
                } catch (e) {
                    console.error('Error loading saved airport data:', e);
                    showStatus('Error loading previous data. Starting fresh.', 'error');
                }
            }

            // Set up event listeners
            setupEventListeners();
            
            // Show storage status
            storageStatus.style.display = 'block';
            updateStorageStatus();
        });

        function setupEventListeners() {
            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop events
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
            
            // Save before page unload
            window.addEventListener('beforeunload', saveDataToStorage);
        }

        // ==================== File Handling ====================
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (!files.length) return;
            
            uploadProgress.style.display = 'block';
            progressBar.style.width = '0%';
            
            let processed = 0;
            const totalFiles = files.length;
            
            // Save a backup before processing
            saveDataToStorage();
            
            Array.from(files).forEach(file => {
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    processAirportCSVFile(file).then((parsedCount) => {
                        processed++;
                        const progress = (processed / totalFiles) * 100;
                        progressBar.style.width = `${progress}%`;
                        
                        // Save after each successful file processing
                        saveDataToStorage();
                        updateStorageStatus();
                        
                        if (processed === totalFiles) {
                            setTimeout(() => {
                                uploadProgress.style.display = 'none';
                                progressBar.style.width = '0%';
                            }, 500);
                            
                            showStatus(`Successfully processed ${totalFiles} airport data file(s)`, 'success');
                            
                            // Update last updated time
                            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                        }
                    }).catch(error => {
                        processed++;
                        showStatus(`Error processing ${file.name}: ${error.message}`, 'error');
                    });
                } else {
                    processed++;
                    showStatus(`Skipped ${file.name}: Not a CSV file`, 'error');
                }
            });
        }

        function processAirportCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true, // Changed from false to true to get proper objects
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        const csvData = results.data;
                        console.log(`Parsed ${file.name}:`, csvData.length, 'records');
                        console.log('First few rows:', csvData.slice(0, 3));
                        
                        // Add file to uploaded files list
                        addFileToList(file.name, csvData.length);
                        
                        // Store CSV data
                        const storedCount = storeAirportCSVData(file.name, csvData);
                        
                        // Update dashboard
                        updateDashboardStats();
                        updateCompleteDataTable();
                        
                        resolve(storedCount);
                    },
                    error: function(error) {
                        console.error('PapaParse error:', error);
                        reject(error);
                    }
                });
            });
        }

        function addFileToList(filename, rowCount) {
            // Check if file already exists in list
            const existingItems = fileList.querySelectorAll('.file-item');
            let fileExists = false;
            
            existingItems.forEach(item => {
                if (item.querySelector('h5').textContent.includes(filename)) {
                    // Update existing item
                    const small = item.querySelector('small');
                    const currentCount = parseInt(small.textContent.match(/\d+/)[0]) || 0;
                    small.textContent = `${rowCount + currentCount} records`;
                    fileExists = true;
                }
            });
            
            if (!fileExists) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.setAttribute('data-filename', filename);
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="file-details">
                            <h5>${filename}</h5>
                            <small>${rowCount} records</small>
                        </div>
                    </div>
                    <span class="badge-uploaded">✓ Uploaded</span>
                `;
                fileList.appendChild(fileItem);
            }
            
            // Save uploaded files list
            saveUploadedFilesList();
        }

        function loadUploadedFilesList() {
            // Clear existing list
            fileList.innerHTML = '';
            
            // Recreate file items from stored data
            const cleanlinessData = airportData.cleanlinessData;
            const terminalData = airportData.terminalData;
            const gateData = airportData.gateData;
            const maintenanceData = airportData.maintenanceData;
            const staffData = airportData.staffData;
            const otherData = airportData.otherData;
            
            // Create file entries for each data type with records
            if (cleanlinessData.length > 0) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="file-details">
                            <h5>cleanliness_data.csv</h5>
                            <small>${cleanlinessData.length} records</small>
                        </div>
                    </div>
                    <span class="badge-uploaded">✓ Loaded</span>
                `;
                fileList.appendChild(fileItem);
            }
            
            if (terminalData.length > 0) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="file-details">
                            <h5>terminal_data.csv</h5>
                            <small>${terminalData.length} records</small>
                        </div>
                    </div>
                    <span class="badge-uploaded">✓ Loaded</span>
                `;
                fileList.appendChild(fileItem);
            }
            
            if (gateData.length > 0) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="file-details">
                            <h5>gate_data.csv</h5>
                            <small>${gateData.length} records</small>
                        </div>
                    </div>
                    <span class="badge-uploaded">✓ Loaded</span>
                `;
                fileList.appendChild(fileItem);
            }
            
            // Add other data files
            otherData.forEach((item, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="file-details">
                            <h5>${item.filename}</h5>
                            <small>${item.data.length} records</small>
                        </div>
                    </div>
                    <span class="badge-uploaded">✓ Loaded</span>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function saveUploadedFilesList() {
            try {
                const fileItems = Array.from(fileList.querySelectorAll('.file-item'));
                const filesInfo = fileItems.map(item => ({
                    name: item.querySelector('h5').textContent,
                    records: item.querySelector('small').textContent
                }));
                localStorage.setItem('airportUploadedFiles', JSON.stringify(filesInfo));
            } catch (e) {
                console.log('Could not save uploaded files list:', e);
            }
        }

        // ==================== Airport Data Storage ====================
        function storeAirportCSVData(filename, data) {
            console.log(`Storing airport data from: ${filename}`, data.length, 'records');
            
            // Validate data
            if (!data || data.length === 0) {
                showStatus(`No valid data found in ${filename}`, 'warning');
                return 0;
            }
            
            // Clean the data (remove empty rows)
            const cleanedData = data.filter(row => {
                // Check if row has any non-empty values
                return Object.values(row).some(value => 
                    value !== undefined && value !== null && value.toString().trim() !== ''
                );
            });
            
            console.log(`Cleaned ${data.length - cleanedData.length} empty rows, keeping ${cleanedData.length} records`);
            
            if (cleanedData.length === 0) {
                showStatus(`No valid data rows found in ${filename}`, 'warning');
                return 0;
            }
            
            // Determine data type based on filename or content
            filename = filename.toLowerCase();
            let dataType = 'other';
            let addedCount = 0;
            
            // Check first row for content hints
            const firstRow = cleanedData[0];
            const rowKeys = Object.keys(firstRow);
            
            if (filename.includes('terminal') || 
                rowKeys.some(key => key && key.toString().toLowerCase().includes('terminal'))) {
                dataType = 'terminal';
                const newData = [...airportData.terminalData, ...cleanedData];
                addedCount = newData.length - airportData.terminalData.length;
                airportData.terminalData = newData;
                
            } else if (filename.includes('gate') || 
                      rowKeys.some(key => key && key.toString().toLowerCase().includes('gate'))) {
                dataType = 'gate';
                const newData = [...airportData.gateData, ...cleanedData];
                addedCount = newData.length - airportData.gateData.length;
                airportData.gateData = newData;
                
            } else if (filename.includes('cleanliness') || 
                      filename.includes('inspection') ||
                      rowKeys.some(key => key && key.toString().toLowerCase().includes('score'))) {
                dataType = 'cleanliness';
                const newData = [...airportData.cleanlinessData, ...cleanedData];
                addedCount = newData.length - airportData.cleanlinessData.length;
                airportData.cleanlinessData = newData;
                updateCharts();
                
            } else if (filename.includes('maintenance') || 
                      filename.includes('issue') ||
                      rowKeys.some(key => key && key.toString().toLowerCase().includes('repair'))) {
                dataType = 'maintenance';
                const newData = [...airportData.maintenanceData, ...cleanedData];
                addedCount = newData.length - airportData.maintenanceData.length;
                airportData.maintenanceData = newData;
                
            } else if (filename.includes('staff') || 
                      filename.includes('employee') ||
                      rowKeys.some(key => key && key.toString().toLowerCase().includes('schedule'))) {
                dataType = 'staff';
                const newData = [...airportData.staffData, ...cleanedData];
                addedCount = newData.length - airportData.staffData.length;
                airportData.staffData = newData;
                
            } else {
                dataType = 'other';
                // Append to otherData
                const existingIndex = airportData.otherData.findIndex(item => 
                    item.filename.toLowerCase() === filename.toLowerCase()
                );
                
                if (existingIndex !== -1) {
                    // Append to existing file data
                    const newData = [...airportData.otherData[existingIndex].data, ...cleanedData];
                    addedCount = newData.length - airportData.otherData[existingIndex].data.length;
                    airportData.otherData[existingIndex].data = newData;
                } else {
                    // Add as new file
                    addedCount = cleanedData.length;
                    airportData.otherData.push({
                        filename: filename,
                        data: cleanedData
                    });
                }
            }
            
            // Show success message
            const typeName = dataType.charAt(0).toUpperCase() + dataType.slice(1);
            showStatus(`Added ${addedCount} ${typeName} records from ${filename} (Total: ${getDataCount(dataType)})`, 'success');
            
            updateDataStorageDisplay();
            updateStorageStatus();
            
            return addedCount;
        }

        function getDataCount(dataType) {
            switch(dataType) {
                case 'terminal': return airportData.terminalData.length;
                case 'gate': return airportData.gateData.length;
                case 'cleanliness': return airportData.cleanlinessData.length;
                case 'maintenance': return airportData.maintenanceData.length;
                case 'staff': return airportData.staffData.length;
                case 'other': return airportData.otherData.reduce((sum, item) => sum + item.data.length, 0);
                default: return 0;
            }
        }

        // ==================== Dashboard Updates ====================
        function updateDashboardStats() {
            // Update terminal count
            document.getElementById('totalTerminals').textContent = 
                airportData.terminalData.length > 0 ? airportData.terminalData.length : 
                getUniqueCount(airportData.cleanlinessData, 'Terminal') || 0;
            
            // Update gate count
            document.getElementById('totalGates').textContent = 
                airportData.gateData.length > 0 ? airportData.gateData.length : 
                getUniqueCount(airportData.cleanlinessData, 'Gate') || 0;
            
            // Calculate average cleanliness score
            const cleanlinessData = airportData.cleanlinessData;
            let avgScore = '0.0';
            let totalIssues = 0;
            
            if (cleanlinessData.length > 0) {
                let totalScore = 0;
                let scoreCount = 0;
                
                cleanlinessData.forEach(item => {
                    // Try to find score in various possible column names
                    const scoreValue = findScoreValue(item);
                    if (!isNaN(scoreValue) && scoreValue > 0) {
                        totalScore += scoreValue;
                        scoreCount++;
                    }
                    
                    // Count issues
                    if (hasIssues(item)) {
                        totalIssues++;
                    }
                });
                
                avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : '0.0';
                console.log(`Average score calculated from ${scoreCount} of ${cleanlinessData.length} records: ${avgScore}`);
            }
            
            // Count maintenance issues
            totalIssues = Math.max(totalIssues, airportData.maintenanceData.length);
            
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalIssues').textContent = totalIssues;
            
            // Auto-save after updating stats
            saveDataToStorage();
        }

        function findScoreValue(item) {
            const scoreKeys = ['Score', 'Cleanliness Score', 'Overall Score', 'Rating', 'Cleanliness Rating', 
                              'Inspection Score', 'Hygiene Score', 'Sanitation Score', 'Grade'];
            
            for (const key of scoreKeys) {
                if (item[key] !== undefined) {
                    const score = parseFloat(item[key]);
                    if (!isNaN(score)) return score;
                }
            }
            
            // Try any key containing 'score' or 'rating'
            for (const key in item) {
                if (key.toLowerCase().includes('score') || key.toLowerCase().includes('rating')) {
                    const score = parseFloat(item[key]);
                    if (!isNaN(score)) return score;
                }
            }
            
            return 0;
        }

        function hasIssues(item) {
            const issueKeys = ['Issue', 'Problem', 'Defect', 'Maintenance Needed', 'Action Required'];
            
            for (const key of issueKeys) {
                if (item[key] && item[key].toLowerCase() !== 'no' && item[key].toLowerCase() !== 'none' && item[key].trim() !== '') {
                    return true;
                }
            }
            
            return false;
        }

        function getUniqueCount(data, fieldName) {
            if (!data || data.length === 0) return 0;
            
            const uniqueValues = new Set();
            const fieldVariations = [fieldName, fieldName.toLowerCase(), fieldName.toUpperCase()];
            
            data.forEach(item => {
                fieldVariations.forEach(field => {
                    if (item[field]) {
                        uniqueValues.add(item[field].toString().trim());
                    }
                });
                
                // Also check for any key containing the field name
                for (const key in item) {
                    if (key.toLowerCase().includes(fieldName.toLowerCase()) && item[key]) {
                        uniqueValues.add(item[key].toString().trim());
                    }
                }
            });
            
            return uniqueValues.size;
        }

        // ==================== Complete Data Table ====================
        function updateCompleteDataTable() {
            const container = document.getElementById('dataTableContainer');
            const cleanlinessData = airportData.cleanlinessData;
            
            console.log('Updating data table with', cleanlinessData.length, 'records');
            
            if (cleanlinessData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-table fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Upload airport cleanliness data to see complete records here.</p>
                    </div>
                `;
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }
            
            totalRecords = cleanlinessData.length;
            displayPage(currentPage);
            updatePaginationControls();
        }

        function displayPage(page) {
            const container = document.getElementById('dataTableContainer');
            const cleanlinessData = airportData.cleanlinessData;
            
            const startIndex = (page - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const pageData = cleanlinessData.slice(startIndex, endIndex);
            
            // Get all unique headers from the data
            const headers = getAllHeaders(cleanlinessData);
            
            console.log(`Displaying page ${page}: ${startIndex} to ${endIndex} of ${totalRecords}`);
            console.log('Headers found:', headers);
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${formatHeader(header)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach((row, index) => {
                const globalIndex = startIndex + index;
                const scoreValue = findScoreValue(row);
                const scoreClass = getScoreClass(scoreValue);
                
                html += '<tr>';
                headers.forEach(header => {
                    let cellValue = row[header] || '';
                    
                    // Format score cells
                    if (header.toLowerCase().includes('score') || header.toLowerCase().includes('rating')) {
                        const score = parseFloat(cellValue);
                        if (!isNaN(score)) {
                            cellValue = `<span class="score-badge ${getScoreClass(score)}">${score.toFixed(1)}</span>`;
                        }
                    }
                    
                    // Format date cells
                    if (header.toLowerCase().includes('date') || header.toLowerCase().includes('time')) {
                        cellValue = formatDate(cellValue);
                    }
                    
                    html += `<td>${cellValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Update records info
            document.getElementById('recordsInfo').textContent = 
                `Showing ${startIndex + 1} to ${endIndex} of ${totalRecords.toLocaleString()} records`;
        }

        function getAllHeaders(data) {
            const headerSet = new Set();
            
            data.forEach(row => {
                Object.keys(row).forEach(key => {
                    if (key && key.trim() !== '') {
                        headerSet.add(key);
                    }
                });
            });
            
            return Array.from(headerSet);
        }

        function formatHeader(header) {
            return header
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .replace(/_/g, ' ');
        }

        function getScoreClass(score) {
            if (score >= 8) return 'score-high';
            if (score >= 6) return 'score-medium';
            return 'score-low';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayPage(currentPage);
                updatePaginationControls();
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const paginationControls = document.getElementById('paginationControls');
            
            paginationControls.style.display = 'block';
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        // ==================== Chart Functions ====================
        function updateCharts() {
            const monthlyData = generateMonthlyData();
            const weeklyData = generateWeeklyData();
            
            // Update or create Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            
            if (monthlyData.labels.length > 0) {
                monthlyChart = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [
                            {
                                label: 'Average Cleanliness Score',
                                data: monthlyData.scores,
                                borderColor: 'rgb(26, 115, 232)',
                                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: 'Target Score',
                                data: monthlyData.labels.map(() => 85),
                                borderColor: 'rgb(52, 168, 83)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Monthly Airport Cleanliness Trends',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Cleanliness Score',
                                    font: {
                                        size: 14
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } else {
                drawNoDataMessage(monthlyCtx, 'Upload airport data to see monthly trends');
            }
            
            // Update or create Weekly Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            if (weeklyChart) weeklyChart.destroy();
            
            if (weeklyData.labels.length > 0) {
                weeklyChart = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: weeklyData.labels,
                        datasets: [{
                            label: 'Weekly Average Score',
                            data: weeklyData.scores,
                            backgroundColor: weeklyData.scores.map(score => {
                                if (score >= 8) return 'rgba(52, 168, 83, 0.7)';
                                if (score >= 6) return 'rgba(251, 188, 4, 0.7)';
                                return 'rgba(234, 67, 53, 0.7)';
                            }),
                            borderColor: weeklyData.scores.map(score => {
                                if (score >= 8) return 'rgb(52, 168, 83)';
                                if (score >= 6) return 'rgb(251, 188, 4)';
                                return 'rgb(234, 67, 53)';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Weekly Airport Cleanliness Performance',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Cleanliness Score',
                                    font: {
                                        size: 14
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
            } else {
                drawNoDataMessage(weeklyCtx, 'Upload airport data to see weekly performance');
            }
        }

        function drawNoDataMessage(ctx, message) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Arial';
            ctx.fillStyle = '#5f6368';
            ctx.textAlign = 'center';
            ctx.fillText(message, ctx.canvas.width/2, ctx.canvas.height/2);
        }

        function generateMonthlyData() {
            const cleanlinessData = airportData.cleanlinessData;
            if (!cleanlinessData || cleanlinessData.length === 0) {
                return { labels: [], scores: [] };
            }
            
            const monthlyScores = {};
            
            cleanlinessData.forEach(item => {
                // Try to find date in various possible column names
                let dateStr = findDateValue(item);
                
                if (dateStr) {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            
                            const score = findScoreValue(item);
                            
                            if (!isNaN(score) && score > 0) {
                                if (!monthlyScores[monthKey]) {
                                    monthlyScores[monthKey] = { total: 0, count: 0 };
                                }
                                
                                monthlyScores[monthKey].total += score;
                                monthlyScores[monthKey].count += 1;
                            }
                        }
                    } catch (e) {
                        console.log('Date parsing error:', e);
                    }
                }
            });
            
            // Calculate averages and sort by date
            const labels = Object.keys(monthlyScores).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            
            const scores = labels.map(month => {
                const data = monthlyScores[month];
                return (data.total / data.count);
            });
            
            return { labels, scores };
        }

        function findDateValue(item) {
            const dateKeys = ['Date', 'Inspection Date', 'Check Date', 'Timestamp', 'Time', 
                             'Inspection Time', 'Recorded At', 'Created At'];
            
            for (const key of dateKeys) {
                if (item[key]) return item[key];
            }
            
            // Try any key containing 'date' or 'time'
            for (const key in item) {
                if (key.toLowerCase().includes('date') || key.toLowerCase().includes('time')) {
                    if (item[key]) return item[key];
                }
            }
            
            return '';
        }

        function generateWeeklyData() {
            const cleanlinessData = airportData.cleanlinessData;
            if (!cleanlinessData || cleanlinessData.length === 0) {
                return { labels: [], scores: [] };
            }
            
            const weeklyScores = {};
            
            cleanlinessData.forEach(item => {
                let dateStr = findDateValue(item);
                
                if (dateStr) {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const weekNumber = getWeekNumber(date);
                            const weekKey = `Week ${weekNumber.week} (${date.getFullYear()})`;
                            
                            const score = findScoreValue(item);
                            
                            if (!isNaN(score) && score > 0) {
                                if (!weeklyScores[weekKey]) {
                                    weeklyScores[weekKey] = { total: 0, count: 0 };
                                }
                                
                                weeklyScores[weekKey].total += score;
                                weeklyScores[weekKey].count += 1;
                            }
                        }
                    } catch (e) {
                        console.log('Date parsing error:', e);
                    }
                }
            });
            
            // Get weeks and sort them
            const allWeeks = Object.keys(weeklyScores).sort((a, b) => {
                const [weekA, yearA] = extractWeekInfo(a);
                const [weekB, yearB] = extractWeekInfo(b);
                return yearA !== yearB ? yearA - yearB : weekA - weekB;
            });
            
            // Get recent weeks (up to 12)
            const recentWeeks = allWeeks.slice(-12);
            
            const scores = recentWeeks.map(week => {
                const data = weeklyScores[week];
                return (data.total / data.count);
            });
            
            return { labels: recentWeeks, scores };
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { year: d.getUTCFullYear(), week: weekNo };
        }

        function extractWeekInfo(weekStr) {
            const match = weekStr.match(/Week (\d+) \((\d+)\)/);
            return match ? [parseInt(match[1]), parseInt(match[2])] : [0, 0];
        }

        // ==================== Data Storage Display ====================
        function updateDataStorageDisplay() {
            // Update summary items
            document.getElementById('terminalCount').textContent = airportData.terminalData.length.toLocaleString();
            document.getElementById('gateCount').textContent = airportData.gateData.length.toLocaleString();
            document.getElementById('cleanlinessCount').textContent = airportData.cleanlinessData.length.toLocaleString();
            document.getElementById('maintenanceCount').textContent = airportData.maintenanceData.length.toLocaleString();
            
            // Update detailed info
            const infoDiv = document.getElementById('dataStorageInfo');
            let html = '<div class="data-summary">';
            
            const dataTypes = [
                { key: 'terminalData', name: 'Terminal Data', count: airportData.terminalData.length },
                { key: 'gateData', name: 'Gate Data', count: airportData.gateData.length },
                { key: 'cleanlinessData', name: 'Cleanliness Data', count: airportData.cleanlinessData.length },
                { key: 'maintenanceData', name: 'Maintenance Data', count: airportData.maintenanceData.length },
                { key: 'staffData', name: 'Staff Data', count: airportData.staffData.length }
            ];
            
            dataTypes.forEach(type => {
                if (type.count > 0) {
                    html += `
                        <div class="data-summary-item">
                            <h5>${type.name}</h5>
                            <p>${type.count.toLocaleString()} records</p>
                        </div>
                    `;
                }
            });
            
            if (airportData.otherData.length > 0) {
                const otherCount = airportData.otherData.reduce((sum, item) => sum + item.data.length, 0);
                html += `
                    <div class="data-summary-item">
                        <h5>Other Data</h5>
                        <p>${otherCount.toLocaleString()} records</p>
                    </div>
                `;
            }
            
            // Calculate total
            let totalRecords = 0;
            for (const key in airportData) {
                if (Array.isArray(airportData[key])) {
                    totalRecords += airportData[key].length;
                }
            }
            
            html += `
                <div class="data-summary-item" style="grid-column: 1 / -1; background: #e8f0fe; border-color: #1a73e8;">
                    <h5><i class="fas fa-database"></i> Total Airport Records</h5>
                    <p>${totalRecords.toLocaleString()} records</p>
                </div>
            `;
            
            html += '</div>';
            infoDiv.innerHTML = html;
        }

        // ==================== Utility Functions ====================
        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status status-${type}`;
            uploadStatus.style.display = 'block';
            
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 5000);
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('airportCleanlinessData', JSON.stringify(airportData));
                localStorage.setItem('airportDataLastUpdated', new Date().toISOString());
                console.log('Airport data saved to local storage');
                return true;
            } catch (e) {
                console.error('Error saving to local storage:', e);
                showStatus('Warning: Could not save data to browser storage (storage might be full)', 'error');
                return false;
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveDataToStorage, 30000);

        // ==================== Storage Status Functions ====================
        function updateStorageStatus() {
            try {
                const dataSize = JSON.stringify(airportData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB typical localStorage limit
                
                const percentUsed = (dataSize / maxSize) * 100;
                const roundedPercent = Math.round(percentUsed);
                
                storagePercent.textContent = `${roundedPercent}%`;
                
                // Update indicator color based on usage
                if (percentUsed > 90) {
                    storageStatus.style.background = '#fce8e6';
                    storageStatus.style.color = '#c5221f';
                    showStatus('Warning: Browser storage is almost full. Export your data soon.', 'error');
                } else if (percentUsed > 70) {
                    storageStatus.style.background = '#fef7e0';
                    storageStatus.style.color = '#b06000';
                    showStatus(`Storage: ${roundedPercent}% used - Consider exporting data`, 'warning');
                } else {
                    storageStatus.style.background = '#e8f0fe';
                    storageStatus.style.color = '#1a73e8';
                }
                
                return percentUsed;
            } catch (e) {
                console.log('Error calculating storage status:', e);
                return 0;
            }
        }

        // ==================== CSV Export Functions ====================
        function convertToCSV(dataArray) {
            if (!dataArray || dataArray.length === 0) {
                return '';
            }
            
            // Get all headers from the data
            const headers = getAllHeaders(dataArray);
            
            // Create CSV string
            let csvString = headers.join(',') + '\n';
            
            // Add data rows
            dataArray.forEach(row => {
                const rowData = headers.map(header => {
                    let value = row[header] || '';
                    
                    // Escape values that contain commas, quotes, or newlines
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                });
                
                csvString += rowData.join(',') + '\n';
            });
            
            return csvString;
        }

        function exportAllDataCSV() {
            // Combine all data into one CSV
            const allData = [
                ...airportData.cleanlinessData,
                ...airportData.terminalData,
                ...airportData.gateData,
                ...airportData.maintenanceData,
                ...airportData.staffData
            ];
            
            // Add other data files
            airportData.otherData.forEach(item => {
                allData.push(...item.data);
            });
            
            if (allData.length === 0) {
                showStatus('No data available to export', 'warning');
                return;
            }
            
            const csvString = convertToCSV(allData);
            const today = new Date().toISOString().split('T')[0];
            const filename = `airport_cleanliness_data_${today}.csv`;
            
            // Create download link
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`Exported ${allData.length} records to CSV file`, 'success');
        }

        // ==================== Debug Functions ====================
        function debugStorage() {
            console.log('=== Airport Dashboard Storage Debug ===');
            console.log('Airport data keys:', Object.keys(airportData));
            console.log('Terminal records:', airportData.terminalData.length);
            console.log('Gate records:', airportData.gateData.length);
            console.log('Cleanliness records:', airportData.cleanlinessData.length);
            console.log('Maintenance records:', airportData.maintenanceData.length);
            console.log('Staff records:', airportData.staffData.length);
            console.log('Other data files:', airportData.otherData.length);
            
            const dataSize = JSON.stringify(airportData).length;
            console.log('Total data size:', formatBytes(dataSize));
            
            const saved = localStorage.getItem('airportCleanlinessData');
            console.log('Data in localStorage:', saved ? 'Yes (' + formatBytes(saved.length) + ')' : 'No');
            console.log('Last updated:', localStorage.getItem('airportDataLastUpdated'));
            
            // Show debug info in status
            const totalRecords = airportData.terminalData.length + airportData.gateData.length + 
                                airportData.cleanlinessData.length + airportData.maintenanceData.length + 
                                airportData.staffData.length + airportData.otherData.reduce((sum, item) => sum + item.data.length, 0);
            
            showStatus(`Debug: ${totalRecords} total records | ${formatBytes(dataSize)} stored`, 'success');
            console.log('==================');
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // ==================== Clear Function ====================
        function clearAllData() {
            if (confirm('Are you sure you want to clear all airport data? This action cannot be undone.')) {
                airportData = {
                    terminalData: [],
                    gateData: [],
                    cleanlinessData: [],
                    maintenanceData: [],
                    staffData: [],
                    otherData: []
                };
                
                // Clear charts
                if (monthlyChart) {
                    monthlyChart.destroy();
                    monthlyChart = null;
                }
                if (weeklyChart) {
                    weeklyChart.destroy();
                    weeklyChart = null;
                }
                
                // Clear UI
                updateDataStorageDisplay();
                updateDashboardStats();
                fileList.innerHTML = '';
                
                // Clear local storage
                localStorage.removeItem('airportCleanlinessData');
                localStorage.removeItem('airportDataLastUpdated');
                localStorage.removeItem('airportUploadedFiles');
                
                // Reset data table
                const container = document.getElementById('dataTableContainer');
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-table fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Upload airport cleanliness data to see complete records here.</p>
                    </div>
                `;
                document.getElementById('paginationControls').style.display = 'none';
                
                // Reset charts display
                const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
                
                drawNoDataMessage(monthlyCtx, 'Upload airport data to see monthly trends');
                drawNoDataMessage(weeklyCtx, 'Upload airport data to see weekly performance');
                
                // Update last updated
                document.getElementById('lastUpdated').textContent = 'Never';
                
                // Update storage status
                updateStorageStatus();
                
                showStatus('All airport data has been cleared successfully!', 'success');
            }
        }
    </script>
</body>
</html>